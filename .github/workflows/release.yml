name: release

on:
  push:
    tags:
      - 'v*' # Triggers on version tags (e.g., v1.0.0)

# 1. Explicitly set top-level permissions to "read-all" as a safety baseline
permissions: read-all

jobs:
  build-and-release:
    name: Build, Attest, and Release
    runs-on: macos-latest
    
    # 2. Grant specific write permissions only to this job
    permissions:
      contents: write      # Required to create the GitHub Release and upload assets
      id-token: write     # Required for signing the Artifact Attestation (OIDC)
      attestations: write # Required to publish the build provenance to GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: '1.25.4'
          cache: true

      - name: Build Locksmith
        run: make release

      # 3. Create the Attestation (The SLSA "Birth Certificate")
      - name: Generate Artifact Attestation
        uses: actions/attest-build-provenance@ef244123eb79f2f7a7e75d99086184180e6d0018 # v1.4.4
        with:
          subject-path: 'bin/*'

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: bin/*
          generate_release_notes: true