name: release

on:
  push:
    tags:
      - 'v*' # Triggers on version tags (e.g., v1.0.0)

# 1. Explicitly set top-level permissions to "read-all" as a safety baseline
permissions: read-all

jobs:
  build-and-release:
    name: Build, Attest, and Release
    runs-on: macos-latest
    
    # 2. Grant specific write permissions only to this job
    permissions:
      contents: write      # Required to create the GitHub Release and upload assets
      id-token: write     # Required for signing the Artifact Attestation (OIDC)
      attestations: write # Required to publish the build provenance to GitHub

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@3041bf56604102f05352ba2bb202f90aef5a3e77 # v5.2.0
        with:
          go-version: '1.21'
          cache: true

      - name: Build Locksmith
        run: make build # Assumes your Makefile builds to bin/locksmith

      # 3. Create the Attestation (The SLSA "Birth Certificate")
      - name: Generate Artifact Attestation
        uses: actions/attest-build-provenance@1c7062403f905e947d7e3a9686036814b304c53d # v1.4.3
        with:
          subject-path: 'bin/locksmith'

      - name: Create Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.9
        with:
          files: bin/locksmith
          generate_release_notes: true